<apex:page docType="html-5.0" controller="TxnCreateChargeController" standardStylesheets="false">
    <head>
        <apex:includescript value="{!URLFOR($Resource.jqueryDatatable_3embed,'/3embed/jquery-1.11.1.min.js')}" />
        <apex:includescript value="{!URLFOR($Resource.jqueryDatatable_3embed,'/3embed/jquery.dataTables.min.js')}" />
        <apex:includeScript value="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.11.2/js/standalone/selectize.min.js"/>
        <apex:stylesheet value="{!URLFOR($Resource.jqueryDatatable_3embed,'/3embed/jquery.dataTables.min.css')}" />
        <apex:stylesheet value="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.11.2/css/selectize.min.css"/>
    </head>   
    <script> 
    $(document).ready(function() {
        $("#paymentTable").DataTable({
            "footerCallback": function ( row, data, start, end, display  ) {
                var api = this.api(), data;
                // Remove the formatting to get integer data for summation
                var intVal = function ( i ) {
                    return typeof i === 'string' ?
                        i.replace(/[\$,]/g, '')*1 :
                    typeof i === 'number' ?
                        i : 0;
                };                
                // Total over all pages
                totalAmount = api
                .column( 4 )
                .data()
                .reduce( function (a, b) {
                    return intVal(a) + intVal(b);
                }, 0 );      
                totalAmount = totalAmount.toFixed(2);
                $(api.column(4).footer()).html(
                    '$'+ totalAmount
                );                        
            }                        
        });
        
   
    });
    $(document).ready(function() {
        initSearchable();
    });

    function initSearchable() {
        $('.searchable').selectize({
            create: false,
            searchField: ['text'],
            sortField: {
                field: 'text',
                direction: 'asc'
            },
            openOnFocus: false,
            onDropdownOpen: function(){
                var yPos = mouseYPos;
                var currentPos = $(window).scrollTop();
                var totalSize =  $(window).height();
                if(yPos+200>totalSize){
                    $(window).scrollTop(currentPos+200);
                }
            },
        });
    }

    function validateFutureDate(dateFieldId) {
        var selectedDate = document.getElementById(dateFieldId).value;
        var today = "{!todayDate}";
        var parseselectedDate = Date.parse(selectedDate);
        var parsetoday = Date.parse(today);
        if (parseselectedDate > parsetoday) {
            if (!confirm("You are about to enter a transaction into the future, is this correct?")) {
                return false;
            }
        }
    }      
    
    function submitCharge() {
        doSubmitCharge();
    }
    /*This function will hide and show the different forms based on the selection of (record type or type)
        i.e payment form will be get shown when payment record type will be selected from the dropdown and all other forms will be get hidden*/
    function hideAndShowForms(selectedOption) {
        var selectedLayout = $(selectedOption).find('option:selected').text();
        switch (selectedLayout) {
            case "Payment":
                $("#paymentForm").show();
                break;
            default:
                $("paymentForm").hide();
        }
        RecordTypeChange();
    }
    
    
    /*This method will show and hide the payment method fields based on the selection
        of payment method from the dropdown i.e If the selected payment method is check than it will show "Check Number and Check Date" fields*/
    function hideAndShowPaymentSection(selectedPaymentType) {
        var paymentMethodSelectedText = $(selectedPaymentType).find("option:selected").val();
        $(".paymentBlock").hide();
        switch (paymentMethodSelectedText) {
            case "Check":
                $("#checkSection").show();
                $("#ExternalCreditCardSection").hide();
                $("#creditCardAch").hide();
                
                break;
            case "ExternalCreditCard":
                $("#ExternalCreditCardSection").show();
                $("#checkSection").hide();
                $("#creditCardAch").hide();
                
                break;
            case "CreditCard":
                $("#creditCardAch").show();
                $("#checkSection").hide();
                $("#ExternalCreditCardSection").hide();
                
                break;
            default:
                $("#checkSection").hide();
                $("#creditCardAch").hide();
                $("#ExternalCreditCardSection").hide();
                
        }
    }

    function hideChargeAmountOnTypeSelection()
    {
      
    }
    /*This method will hide and show the charges table based on the selection of manual paying checkbox*/
    function hideAndShowChargesTable(checkBoxStatus) {
        var isPayingManually = $(checkBoxStatus).prop("checked");
        if (isPayingManually) {
            var amt = (0.000).toFixed(2);
            if ($('[id$=paymentAmount]').val() != '')
                amt = parseFloat($('[id$=paymentAmount]').val()).toFixed(2);
            
            $('#remaining_Payment_amount').text(amt);
            $('#Payment_amount').text(amt);
            
            $("#chargesTable").show();
            return;
        }
        $("#chargesTable").hide();
    }              
    $('.Payment_method').hide();
    function show_payment_method(Type){
        var type=$(Type).find("option:selected").val();        
        if(type=='012o000000046WJAAY'){
            $('.Payment_method').show();
        }else{
            
            $('.Payment_method').hide();
        }
    }
    
    $('.paymentBlockCard').hide(); 
    $('.paymentBlockExternal').hide(); 
    $('.paymentBlockCheck').hide();
    
    if($('[id$=PayemntTypes]').val()=='ExternalCreditCard'){ 
        
        $('.paymentBlockExternal').show();                          
    }
    if($('[id$=PayemntTypes]').val()=='CreditCard'){ 
        
        $('.paymentBlockCard').show();                          
    }
    if($('[id$=PayemntTypes]').val()=='Check'){ 
        
        $('.paymentBlockCheck').show();                         
    }
    if($('[id$=RecordTypeFromDb]').val()=='012o000000046WJAAY'){ 
        
        $('.Payment_method').show();                        
    }        
    
    function chargeNowJS(){ 
        disablebutton();
        var paymentTypes=$('[id$=PayemntTypes]').val();                           
        if(typeof bmcSaveBillAddrAF == 'function' && paymentTypes=='CreditCard')
        {              
            bmcCallBackMethod = PaydoSave;
            bmcSaveBillAddrAF();                
        }
        else{           
            PaydoSave();               
        } 
        
    };
    function disablebutton()
    {
        $('[id$=btn]').prop("disabled",true);  
    }
    
    function enablebutton()
    {
        $('[id$=btn]').prop("disabled",false);
        
    }
    
    function PaydoSave(node){             
        var paymentTypes=$('[id$=PayemntTypes]').val();                           
        if(paymentTypes=='CreditCard'){
            if(bmcPaymentId!="")
            {
                $('[id$=transactionId]').val(bmcPaymentId);     
            }  else{
                alert('Payment failed. Try again later.');    
            }
        }else{
            bmcPaymentId='';
            $('[id$=transactionId]').val(''); 
            }                         
        var arr = {"data": allChargesJson};      
        paraFunction(JSON.stringify(arr));
        
    }       
    </script>   
    <style>
        body .bPageBlock .pbBody .red .pbSubheader{
        background-color:#6666FF;
        } 
        .panelWrapper .mainTitle 
        {
        background-color: #6666FF !important;
        color:white !important;
        
        }
        
         .popup
        {
        background-color: white;
        border-width: 2px;
        border-style: solid;
        z-index: 9999;
        left: 50%;
        padding:10px;
        position: absolute;
        width: 500px;
        margin-left: -250px;
        top:80px;
        }
        
        .popupBg
        {
        background-color:black;
        opacity: 0.20;
        filter: alpha(opacity = 70);
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: 9998;
        }
        
        .vfHelpText a            {position:relative;}
        .vfHelpText a span       {display: none;}
        .vfHelpText a:hover span {display: block;
                                  position:absolute;
                                  top:1.25em;
                                  padding:2px 5px;
                                  left:-15em; width:15em;
                                  z-index:100;
                                  border:1px solid orange;
                                  background-color:#FEFDB9;
                                  color:black;
                                 }
       
     body .bPageBlock .pbBody .red .pbSubheader{
        background-color:#1797c0;
        }
    
        
        
    </style>  
    
    <apex:pageBlock > 
        <apex:outputPanel styleClass="red" >
            <apex:pageBlockSection title="{!memName}"><a href='{!FromLink}'><b>{!breadCrumb}</b></a> > <b>{!currentPage}</b></apex:pageBlockSection>
        </apex:outputPanel>
        <apex:pageBlockSection id="errmsgs">
            <apex:pageMessages id="msgs" escape="false"></apex:pageMessages>
        </apex:pageBlockSection> 
        <style>
        #finlink{
          color: green;
        }
        #finlink:hover {
         color: red;
        }    
        </style>        
    </apex:pageBlock>
    
    <apex:pageBlock rendered="{!EditPg1}"  > 
        <a href="/{!ChargeId}">(View Default Detail page)</a>
    </apex:pageBlock>
        
    <apex:pageBlock id="msgs">
        <apex:form id="ChargeForm">            
            <apex:outputPanel >                            
            <apex:actionstatus id="loading">
                <apex:facet name="stop"></apex:facet>
                <apex:facet name="start">
                    <div class="waitingSearchDiv" id="el_loading" style="z-index:999;width:100%">
                        <div class="waitingHolder" style="z-index:999; opacity:1.0;position:fixed;top:200px;right:50%;margin-right:-100px; width: 100px;height: 25px;background-color: #fff;border: 1px solid black;border-radius: 5px;padding-top: 10px;color: #000;">
                            <img class="waitingImage" src="/img/loading.gif" title="Please Wait..." />
                            <span class="waitingDescription" style="color:#000; opacity:1.0;">Working...</span>
                        </div>
                    </div>
                </apex:facet>
            </apex:actionstatus>
         <apex:inputHidden value="{!ChargeType}" id="companyDef"/>
         <apex:inputHidden value="{!ChargeSubType}" id="companyDef1"/>
         <apex:actionFunction name="doSubmitCharge" action="{!save}" status="loading" oncomplete="doSendToAuthorizeAF();" rerender="form,MSGS,errmsgs">
            <apex:param name="p1" value="" assignTo="{!paymentMethodId}"/>
         </apex:actionFunction>
            
         <apex:outputPanel styleClass="red" >
            <apex:pageBlockSection collapsible="false" title="Select Types" columns="2" >
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Charge Item :"  />
                    <apex:outputPanel layout="block">
                        <apex:selectList value="{!selectedChargeItem}" size="1" disabled="{!DetailPage}" styleClass="searchable">
                            <apex:selectOptions value="{!chargeItemOptions}"/>
                            <apex:actionSupport status="loading" event="onchange" action="{!selectChargeItem}" oncomplete="calculateTax()" reRender="ChargeType,ChargeSubType,Description,amountSection,taxSection"/>
                        </apex:selectList>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Quantity :"  />
                    <apex:outputPanel layout="block">
                        <apex:inputField type="number" value="{!othCharge.Quantity__c}" onkeyup="calculateTax()" onmouseup="calculateTax()" id="QtyID" />
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Item Code :" />
                        <apex:outputPanel layout="block">
                            <apex:outputText value="{!itemCode}" />
                        </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Statement Description :"  />
                    <apex:outputPanel layout="block">
                        <apex:inputField value="{!othCharge.Statement_Description__c}"  />
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Type :" />
                        <apex:outputPanel layout="block">
                            <apex:outputText value="{!othCharge.GlobalType__c}" id="ChargeType" />
                        </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Charge Date :"/>
                        <apex:outputPanel layout="block">
                            <div class="requiredInput">
                                 <apex:inputField type="date" onchange="validateFutureDate(this);" value="{!othCharge.Date__c}" style="width: 40%;" id="DateFromDB"/>
                            </div>                           
                        </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Sub Type :"/>
                        <apex:outputPanel layout="block">
                            <apex:outputText value="{!othCharge.GlobalSubType__c}" id="ChargeSubType" />
                        </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem > 
                    <apex:outputLabel value="Notes :" />
                    <apex:outputPanel >
                        <apex:inputField value="{!othCharge.Internal_Notes__c}"  />
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem > 
                    <apex:outputLabel value="Tax Exempt" />
                    <apex:outputPanel >
                        <apex:inputCheckbox id="taxEmptCheckBox" onclick="select_Charge(this,'')" value="{!othCharge.Tax_Exempt__c}"  />
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Description :" />
                    <apex:outputPanel >
                        <apex:outputText value="{!charge_desc}" id="Description"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem > 
                    <apex:outputLabel value="Employee" />
                    <apex:outputPanel >
                        <apex:inputField id="idxEmpLookup" value="{!othCharge.Employee__c}"  />
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem />
                
                <!--<apex:pageBlockSectionItem rendered="{!displaylookup}">
                    <apex:outputLabel value="Financial Sponsor :" />
                        <apex:outputPanel >
                            <div class="requiredInput" >
                                <div class="requiredBlock"></div>
                                <apex:inputField value="{!refmem.Sponsor_1_Name__c}"/>
                            </div>
                        </apex:outputPanel>
                </apex:pageBlockSectionItem>-->
                
                <apex:pageBlockSectionItem rendered="{!DetailPage}">
                    <apex:outputLabel value="Status :"/>
                        <apex:outputPanel layout="block">
                            {!StatusOfStatus}
                        </apex:outputPanel>
                </apex:pageBlockSectionItem> 
                
            </apex:pageBlockSection>
             
        </apex:outputPanel>              
        <apex:outputPanel styleClass="red" id="amountSection">
            
            <apex:pageBlockSection collapsible="false" title="Amount and Description" columns="2" >
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Charge Amount :"/>
                    <apex:outputPanel layout="block">
                        <apex:inputText value="{!Charge_Amount}" onkeyup="calculateTax()" disabled="{!DetailPage}" id="ChargeAmountID"  />
                        <apex:inputHidden id="TaxApplyOnServiceCharge" value="{!tax_applied_on_Service_charge}"/>
                        <apex:inputHidden id="taxes_on_service_charge" value="{!taxes_on_service_charge}"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem /><!-- space holder -->
                <apex:pageBlockSectionItem > 
                    <apex:outputLabel value="Service Charge :"/>
                    <span>{!serviceChargeName} {!serviceChargeStatusText}</span>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Service Charge Amount :"/>
                    $<span id="Service_charge_amt" >{!serviceChargeAmount}</span>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Service Charge Rate :"/>
                    <span id="ServiceCharge_amt">{!serviceChargePercent}</span>%
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Sub Total :"/>
                    $<span id="amount_With_serviceCharge" >{!Sub_Total}</span>
                </apex:pageBlockSectionItem>

                <!-- <apex:pageBlockSectionItem >
                    <apex:outputPanel layout="block">
                        <apex:outputLabel value="Charge Amount :" />

                            <apex:inputText value="{!Charge_Amount}" onkeyup="calculateTax(this)" style="margin-left:30.6%" disabled="{!DetailPage}" id="ChargeAmountID"  />
                        <a id="reFundButton" target='_new' href='/apex/TxnAdjustment?from=MemberPayement&ContactType=member&ChargeId={!ChargeId}' 
                                  style="display: none;"><button type='button' style=" width: 203px;height: 30px;color:white;background: #6666FF;" id='Refund'>Adjust Amount</button>  </a> 
                            <br/><br/>
                            <apex:inputHidden id="TaxApplyOnServiceCharge" value="{!tax_applied_on_Service_charge}"/>
                            <apex:inputHidden id="taxes_on_service_charge" value="{!taxes_on_service_charge}"/>   
                            <apex:outputLabel rendered="{!isServiceChargeEnabled}">
                                <span>Service Charge ({!serviceChargeName})({!serviceChargeStatusText}):<b id="ServiceCharge_amt"  style="margin-left:3.0%">{!serviceChargePercent}</b>% </span>
                                <span id="Service_charge_amt" style="margin-left:4%" >{!serviceChargeAmount}</span>
                                <br/><br/>
                                <span>Sub Total:</span>
                                <span id="amount_With_serviceCharge" style="margin-left:34%" >$ {!Sub_Total} </span>
                                
                            </apex:outputLabel>
                    </apex:outputPanel>
                 </apex:pageBlockSectionItem> -->
             </apex:pageBlockSection>
         </apex:outputPanel>
                
        <script>
            $(document).ready(function() {
            $(".dbl-mask").mask("999 999 999.99");});
</script> 
                
                 <script>
                if(!{!DetailPage})
 $("#AdjustedBlock").hide();
                </script>
               
       <apex:outputPanel styleClass="red" rendered="{!EditPg}" id="taxSection">         
            <apex:pageBlockSection collapsible="false" title="Tax Details" columns="1" rendered="{!isTaxEnabled}">
                    <table class="table" style="width:75%;" id="taxTable">
                        <tr>
                            <th style="width:40%;">Tax Name</th>
                            <th style="width:10%;">Percentage (%)</th>
                            <th style="width:25%;">Amount ($)</th>
                          <!--  <th style="width:25%;">Tax Exemption</th> -->
                        </tr>
                        <tbody>
                            <apex:repeat value="{!taxMap}" var="tax">
                                <tr>
                                    <td>{!tax}</td>
                                    <td>{!taxMap[tax]}</td>
                                    <td>0.00</td>                                    
                                  <!--  <td><input type="checkbox" onclick="select_Charge(this,'{!taxMap[tax]}')" id="checkbox" /></td> -->
                                </tr>
                            </apex:repeat>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td></td>
                                <td><b>Final Total :</b></td>
                                <td><b><span id="FinalTotal">{!Final_Total}</span></b></td>
                            </tr>
                        </tfoot>
                    </table>                
                <apex:pageBlockSectionItem dataStyleClass="ExemptNumber" dataStyle="display : none;">
                    <apex:outputPanel layout="block">
                        <apex:outputLabel value="Tax Exempt Number :" styleClass="ExemptNumber"/>
                            <apex:inputText value="{!exemptNumber}" id="exemptNumber" style="margin-left:1.6%" disabled="{!DetailPage}" />
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
           </apex:pageBlockSection>
        </apex:outputPanel>
        <apex:outputPanel styleClass="red" rendered="{!EditPg1}" >  
            <apex:pageBlockSection collapsible="false" title="Adjustments Details" columns="1">
                <apex:pageblockTable value="{!allAdjustments}" var="wrapRec">
                <apex:column value="{!wrapRec.Reason}" >
                    <apex:facet name="header">Adjustment Reason</apex:facet>
                </apex:column>
                <apex:column value="{!wrapRec.Dt}">
                    <apex:facet name="header">DateTime</apex:facet>
                </apex:column>
                <apex:column value="{!wrapRec.Amount}">
                    <apex:facet name="header">Amount ($)</apex:facet>
                    
                </apex:column>
               
              </apex:pageblockTable>
        </apex:pageBlockSection>
        <apex:pageBlockSection collapsible="false" title="Tax Details" columns="1">
                <apex:pageblockTable value="{!allCharges}" var="wrapRec">
                <apex:column value="{!wrapRec.TaxName}" >
                    <apex:facet name="header">Tax Name</apex:facet>
                </apex:column>
                <apex:column value="{!wrapRec.Per}">
                    <apex:facet name="header">Percentage (%)</apex:facet>
                    <apex:facet name="footer">
                      Total Amount : <br/><br/>   Adjusted Amount : <br/><br/> Final Amount : 
                    </apex:facet>
                </apex:column>
                <apex:column value="{!wrapRec.Amount}">
                    <apex:facet name="header">Amount ($)</apex:facet>
                    <apex:facet name="footer">
                        ${!Total} <br/><br/> ${!Adjt_amt_detail} <br/><br/> ${!Final_Total}
                    </apex:facet>
                </apex:column>
               <!-- <apex:column > 
                    <apex:facet name="header">Tax Exemption</apex:facet>
                      <apex:inputCheckbox value="{!wrapRec.Exumption}"  disabled="true" />
                </apex:column> -->
              </apex:pageblockTable>
        </apex:pageBlockSection>
            
        </apex:outputPanel>
   
        <apex:outputPanel styleClass="red" rendered="{!DetailPage}">         
            <apex:pageBlockSection collapsible="false" title="Payments and credits to clear this charge" columns="1"></apex:pageBlockSection>
        </apex:outputPanel><br/>
        <apex:outputPanel rendered="{!DetailPage}">
               <table id="paymentTable" style="width:100%; padding-top:20px;">
                    <thead>
                        <tr>                          
                            <th>Transaction Id</th>
                            <th>Payment Method</th>
                            <th>Transaction Date</th>
                            <th>Details</th>
                            <th>Amount</th>
                            <th>Paid By</th>
                        </tr>
                    </thead>
                    <tbody>
                        <apex:repeat value="{!allpayment}" var="allC">
                            <tr id="{!allC.Name}">
                                <td><a href='{!allC.detailLink}' target='_blank'>{!allC.Name}</a></td>
                                <td>{!allC.paymentType}</td>
                                <td>
                                    <apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                        <apex:param value="{!allC.chargeDate}" />
                                    </apex:outputText>
                                </td>                                
                                <td>{!allC.details}</td>
                                <td>${!allC.amt}</td>
                                <td>{!allC.paidBy}</td>
                            </tr>
                        </apex:repeat>
                    </tbody>
                    <tfoot>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th>Total</th>
                            <th>0.00</th>
                            <th></th>
                   </tfoot>
                </table>
         </apex:outputPanel>
       
            <apex:actionFunction name="paraFunction"  status="loading" action="{!save}" rerender="msgs1,errmsgs">      
                <apex:param id="anode" name="node" value="" />
                <apex:param name="nickName" value="" assignTo="{!nickName}"/>
            </apex:actionFunction> 
            <!--<apex:pageBlock rendered="{!EditPg}">
                <div align="center">
                    <apex:commandButton value="Save and Exit" onclick="doSave1();return false;"  status="loading"  style=" width: 203px;height: 30px; color:white;background:#1797c0;" rendered="{!isMember}" />
                    <apex:commandButton value="Save and New" status="loading" onclick="doSave();return false;"  style=" width: 203px;height: 30px; color:white;background:#1797c0;" rendered="{!isMember}" />
                </div>
            </apex:pageBlock>-->
            <apex:pageBlock rendered="{!EditPg}">
                <div align="center">
                    <apex:commandButton value="Save and Exit" onclick="doSave1();return false;"  status="loading"  style=" width: 203px;height: 30px; color:white;background:#1797c0;" />
                    <apex:commandButton value="Save and New" status="loading" onclick="doSave();return false;"  style=" width: 203px;height: 30px; color:white;background:#1797c0;"/>
                </div>
            </apex:pageBlock>
    
            </apex:outputPanel>                                    
     <!--<apex:pageBlock id="PAYMENTBLOCK" rendered="{!isGuest}">    
        <div id="paymentForm">
             <apex:actionFunction name="paraFunction"  status="loading" action="{!save}" rerender="msgs,msgs1,errmsgs">      
                 <apex:param id="anode" name="node" value="" />
                  <apex:param name="nickName" value="makePayment" assignTo="{!nickName}"/>
             </apex:actionFunction> 
             
         <apex:inputHidden value="{!transactionId}" id="transactionId"/>
         <apex:actionstatus id="loading" onstop="enablebutton();">
             <apex:facet name="stop">
             </apex:facet>
             <apex:facet name="start" >
                 <div class="waitingSearchDiv" id="el_loading" style="z-index:999;width:100%">
                     <div class="waitingHolder" style="z-index:999; opacity:1.0;position:fixed;top:200px;right:50%;margin-right:-100px; width: 100px;height: 25px;background-color: #fff;border: 1px solid black;border-radius: 5px;padding-top: 10px;color: #000;">
                         <img class="waitingImage" src="/img/loading.gif" title="Please Wait..." />
                         <span class="waitingDescription" style="color:#000; opacity:1.0;">Working...</span>
                     </div>
                 </div>
             </apex:facet>
         </apex:actionstatus>
         
         <apex:outputPanel styleClass="red" >
             <apex:pageBlockSection title="Payment Block" collapsible="false" columns="1">                 
                 <apex:pageBlockSectionItem >
                <apex:outputLabel value="Select payment Method :" /> 
                     <apex:outputPanel >
                      <div class="requiredInput" >
                          <div class="requiredBlock"></div>
                <apex:selectList value="{!paymentType}" size="1" onchange="hideAndShowPaymentSection(this)" id="PayemntTypes" disabled="{!DetailPage}">   
                    <apex:selectOption itemValue="" itemLabel="Select Payment Method"></apex:selectOption>
                    <apex:selectOption itemValue="Cash" itemLabel="Cash"></apex:selectOption>
                    <apex:selectOption itemValue="Check" itemLabel="Check"></apex:selectOption>
                    <apex:selectOption itemValue="ExternalCreditCard" itemLabel="External Credit Card"></apex:selectOption>
                    <apex:selectOption itemValue="CreditCard" itemLabel="Credit card/ACH"></apex:selectOption>
                </apex:selectList>
                     </div>
                     </apex:outputPanel>
            </apex:pageBlockSectionItem> 
                 
                 <apex:pageBlockSectionItem >
                     <apex:outputLabel value="Payment Date:"/>
                     <apex:inputField value="{!othCharge.Date__c}" type="date" id="PaymentDate" style="width: 15%;"/>                  
                 </apex:pageBlockSectionItem>  
                 
                 <apex:pageBlockSectionItem >
                     <apex:outputlabel >Description:</apex:outputlabel>
                     <apex:outputPanel >
                     <div class="requiredInput" >
                          <div class="requiredBlock"></div>
                     <apex:inputField value="{!othCharge.Description__c}" style="height:115%;width:38%"  id="Description"/>
                     </div>
                     </apex:outputPanel>
                 </apex:pageBlockSectionItem>
             </apex:pageBlockSection>
         </apex:outputPanel>
         <apex:pageBlockSection >
             <apex:pageBlockSectionItem ></apex:pageBlockSectionItem>
            </apex:pageBlockSection>
         <div id="checkSection" style="display:none" class="paymentBlockCheck">            
                 <apex:pageBlockSection columns="1" collapsible="false">
                     <apex:pageBlocksectionItem >
                         <apex:outputLabel >Check Number:</apex:outputLabel>
                         <apex:outputPanel >
                             <div class="requiredInput" >
                                 <div class="requiredBlock"></div> 
                                 <apex:inputField value="{!othCharge.Check_Number__c}" required="false" label="Check Number:"/>
                             </div>
                         </apex:outputPanel>
                     </apex:pageBlocksectionItem>
                     
                     <apex:pageblockSectionItem >
                         <apex:outputLabel >Check Date:</apex:outputLabel>
                         <apex:outputPanel >
                             <div class="requiredInput" >
                                 <div class="requiredBlock"></div> 
                                 <apex:inputField value="{!othCharge.Check_Date__c}" required="false" label="Check Date:"/>
                             </div>
                         </apex:outputPanel>
                     </apex:pageblockSectionItem>                    
                 </apex:pageBlockSection>
         </div>
         
         <div id="ExternalCreditCardSection" style="display:none" class="paymentBlockExternal">
             <apex:outputPanel styleClass="red" >
                 <apex:pageBlockSection columns="1" collapsible="false">
                     <apex:pageBlockSectionItem >
                         <apex:outputLabel >External Payment Method</apex:outputLabel>  
                         <apex:outputPanel >
                             <div class="requiredInput">
                                 <div class="requiredBlock"></div>
                                 <apex:inputField value="{!othCharge.External_Payment_Method__c}" id="ExternalPaymentMethod"></apex:inputField>   
                             </div>
                         </apex:outputPanel>
                     </apex:pageBlockSectionItem>   
                     
                     <apex:pageBlockSectionItem >
                         <apex:outputLabel >External Payment Method Last 4 Digits</apex:outputLabel>
                         <apex:outputPanel >
                         <div class="requiredInput" >
                          <div class="requiredBlock"></div>
                         <apex:inputField value="{!othCharge.External_Payment_Method_Last_4_Digits__c}" required="false" id="ExternalPaymentMethodLast4Digits"/>
                         </div>
                         </apex:outputPanel>
                     </apex:pageBlockSectionItem>
                     
                     <apex:pageBlockSectionItem >
                         <apex:outputLabel >External Payment Transaction Code</apex:outputLabel>
                         <apex:outputPanel >
                         <div class="requiredInput" >
                          <div class="requiredBlock"></div>
                         <apex:inputField value="{!othCharge.External_Payment_Transaction_Code__c}" required="false" id="ExternalPaymentTransactionCode"/>
                         </div>
                         </apex:outputPanel>
                     </apex:pageBlockSectionItem>
                     
                     <apex:pageBlockSectionItem >
                         <apex:outputLabel >External Payment Authorization Code</apex:outputLabel>
                         <apex:outputPanel >
                         <div class="requiredInput" >
                          <div class="requiredBlock"></div>
                         <apex:inputField value="{!othCharge.External_Payment_Authorization_Code__c}" id="ExternalPaymentAuthorizationCode"/>
                         </div>
                         </apex:outputPanel>
                     </apex:pageBlockSectionItem>                
                 </apex:pageBlockSection>
             </apex:outputPanel>
         </div>                         
             <Section></apex:pageBlockSection>apex:pageBlock rendered="{!EditPg}">
                 <apex:actionstatus id="loading" onstop="enablebutton();">
                     <apex:facet name="stop"></apex:facet>
                     <apex:facet name="start">
                         <div class="waitingSearchDiv" id="el_loading" style="z-index:999;width:100%">
                             <div class="waitingHolder" style="z-index:999; opacity:1.0;position:fixed;top:200px;right:50%;margin-right:-100px; width: 100px;height: 25px;background-color: #fff;border: 1px solid black;border-radius: 5px;padding-top: 10px;color: #000;">
                                 <img class="waitingImage" src="/img/loading.gif" title="Please Wait..." />
                                 <span class="waitingDescription" style="color:#000; opacity:1.0;">Working...</span>
                             </div>
                         </div>
                     </apex:facet>
            </apex:actionstatus>
                 <div align="center" >
                     <apex:commandButton id="btn" status="loading" onclick="chargeNowJS();return false;" value="Make Payment"  style=" width: 203px;height: 30px;color:white;background: #6666FF;" rerender="PAYMENTBLOCK"/>  
                 </div>
             </apex:pageBlock>
         </div>
            </apex:pageBlock>-->
         </apex:form>
    </apex:pageBlock>                         
            
    <script>  
    $('[id$=summary]').hide();
    $('[id$=JOURNALtABLE]').hide();
    var pg = '{!DetailPage}';
    if (pg === 'true') {
        //alert('i am at TOP');
     $("[id$=reFundButton]").show();
     $("[id$=ChargeType]").prop("disabled", true);
        //alert('After Type');
     $("[id$=ChargeSubType]").prop("disabled", true);
        //  alert('After Subtype');
     $("[id$=chargeAmount]").prop("disabled", true);
     $("[id$=DateFromDB]").prop("disabled", true);
 }

 function calculateTax() {
     
    var fieldAmount = $('[id$=ChargeAmountID]').val();
    var TaxApplyOnServiceCharge = $('[id$=TaxApplyOnServiceCharge]').val(); 
    var taxes_on_service_charge = $('[id$=taxes_on_service_charge]').val(); 
    var qty = $('[id$=QtyID]').val();

     var taxArray = [];

     if(taxes_on_service_charge && taxes_on_service_charge !== '')
        taxArray = taxes_on_service_charge.split(",");

     var table = $("#taxTable tbody");
     var chargeAmount1 = fieldAmount * qty;
     var FianlTotal = 0.00;
     var originalAmount = chargeAmount1;
     if (chargeAmount1 == '') {
         chargeAmount1 = 0.00;
     }
     FianlTotal = chargeAmount1;
     var service_charge = $('[id$=ServiceCharge_amt]').html();
     
     if (service_charge !== '' && typeof service_charge != 'undefined') {
        
         serviceChargeAmt = (chargeAmount1 * service_charge / 100).toFixed(2);
      
         if (TaxApplyOnServiceCharge === 'false') {           
             FianlTotal = parseFloat(parseFloat(serviceChargeAmt) + parseFloat(chargeAmount1)).toFixed(2);
             $("#Service_charge_amt").html(serviceChargeAmt);
             $("#amount_With_serviceCharge").html(FianlTotal);
         } else {          
             chargeAmount1 = parseFloat(parseFloat(serviceChargeAmt) + parseFloat(chargeAmount1)).toFixed(2);
             FianlTotal = chargeAmount1;
             $("#Service_charge_amt").html(serviceChargeAmt);
             $("#amount_With_serviceCharge").html(chargeAmount1);
         }

     }
  
     var local = 0;
     var totRow = 0;
     var taxExTrueOrFalse = false;
     table.find('tr').each(function(i) {
         totRow++;
        // alert(jQuery('[id$=taxEmptCheckBox]').is(':checked'));
         var $tds = $(this).find('td');        
         if (jQuery('[id$=taxEmptCheckBox]').is(':checked') === false) {
             //var $tds = $(this).find('td'),
             var percatage = $tds.eq(1).text();
          
             var i = 1;
             var tax = $tds.eq(0).text();
             var check = 0;
             
             for(i=1;i<taxArray.length;i++){
                
                 if(tax == taxArray[i])
                 {
                    check = 1;
                 }
             }
             if(check != 1)
                 {
                     amount = (originalAmount*percatage)/100;
                 }
             else{
                 amount = chargeAmount1 * percatage / 100;
                 }
             check = 0;
             FianlTotal = parseFloat(parseFloat(FianlTotal) + parseFloat(amount.toFixed(2)));
             if (local < FianlTotal) {
                 local = FianlTotal;
             }
             $tds.eq(2).text(amount.toFixed(2));
         }else {
             taxExTrueOrFalse = true;
             $tds.eq(2).text(amount.toFixed(2));
             /*alert('local====>'+local);
             alert('FianlTotal====>'+FianlTotal);
             alert('chargeAmount1====>'+chargeAmount1);*/
             if (TaxApplyOnServiceCharge === 'false') { 
                 local = FianlTotal;
                 //alert('local==2==>'+local);
             }else {
                 local = chargeAmount1;
             }
             //alert('local==3==>'+local);
         }
     });  
     //alert('Final *******local========>'+local);
     if(taxExTrueOrFalse) {
         $("#FinalTotal").html(local);
     }else {
        $("#FinalTotal").html(local.toFixed(2));
     }
 }

 function submitCharge() {
     doSubmitCharge();
 }
 var allChargesJson = [];

 function select_Charge(cb, idstatus) {  
     var exampt = '{!Tax_exempt}';
     if (exampt === 'false') {
         alert('Oops. Sorry you do not have tax exempt permission.');
         $(cb).prop("checked", false);
         return false;
     }

     var charge = {};
     charge.TaxName = $(cb).closest('tr').find('td:eq(0)').text();

     if (cb.checked == true) {
         $('.ExemptNumber').show();
         /*charge.Amount = $(cb).closest('tr').find('td:eq(2)').text(); 
         $(cb).closest('tr').find('td:eq(2)').text('0.00');
         allChargesJson.push(charge);
         var FT = $("#FinalTotal").html();
         var newFT = parseFloat(FT) - parseFloat(charge.Amount);
         $("#FinalTotal").html(newFT.toFixed(2));*/
         calculateTax();
     } else {

         /*for (var i = 0; i < allChargesJson.length; i++) {           
             if (allChargesJson[i].TaxName == charge.TaxName) {               
                 $(cb).closest('tr').find('td:eq(2)').text(allChargesJson[i].Amount);
                 var FT = $("#FinalTotal").html();
                 var newFT = parseFloat(FT) + parseFloat(allChargesJson[i].Amount);
                 $("#FinalTotal").html(newFT.toFixed(2));

                 allChargesJson.splice(i, 1);
             }
         }*/
         calculateTax();
         if (allChargesJson.length === 0) {
             $('.ExemptNumber').hide();
         }
     }
 }

 function doSave(node) {
     var exampt = '{!Tax_exempt}';
     if (exampt !== 'false') {
         var exempt_number_db = '{!HTMLENCODE(tax_exempt_number)}';
         var exempt_number_page = $("[id$=exemptNumber]").val();
         if (exempt_number_page === '' && allChargesJson.length > 0) {
             alert('Please, Enter Tax Exempt Number.');
             return false;
         }
         if (exempt_number_db !== exempt_number_page && allChargesJson.length > 0) {
             alert('Oops. Exempt number didnt match.');
             return false;
         }
     }
     var arr = {
         "data": allChargesJson
     };
     paraFunction(JSON.stringify(arr), 'saveNew');
 }

 function doSave1(node) {
     var exampt = '{!Tax_exempt}';
     //var exampt = jQuery('[id$=taxEmptCheckBox]').is(':checked');
     //alert('==='+exampt);
     if (exampt == 'false') {
     //alert('===');
         var exempt_number_db = '{!HTMLENCODE(tax_exempt_number)}';
         var exempt_number_page = $("[id$=exemptNumber]").val();
         if (exempt_number_page === '' && allChargesJson.length > 0) {
             alert('Please, Enter Tax Exempt Number.');
             return false;
         }
         if (exempt_number_db !== exempt_number_page && allChargesJson.length > 0) {
             alert('Oops. Exempt number didnt match.');
             return false;
         }
     }
     var arr = {
         "data": allChargesJson
     };
     paraFunction(JSON.stringify(arr), 'save');
 }
    /* Guest Button*/
     function doSave1(node) {
     var exampt = '{!Tax_exempt}';
     if (exampt !== 'false') {
         var exempt_number_db = '{!HTMLENCODE(tax_exempt_number)}';
         var exempt_number_page = $("[id$=exemptNumber]").val();
         if (exempt_number_page === '' && allChargesJson.length > 0) {
             alert('Please, Enter Tax Exempt Number.');
             return false;
         }
         if (exempt_number_db !== exempt_number_page && allChargesJson.length > 0) {
             alert('Oops. Exempt number didnt match.');
             return false;
         }
     }     
     var arr = {
         "data": allChargesJson
     };
     paraFunction(JSON.stringify(arr), 'save');
    }  
  
    if({!DetailPage}){          
        $('[id$=reservation]').attr('disabled','disabled');
        $('[id$=folio]').attr('disabled','disabled');   
    }
   

 </script>
</apex:page>